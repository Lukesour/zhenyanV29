<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éªŒè¯ç ä¿®å¤æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success { border-color: #52c41a; background-color: #f6ffed; }
        .error { border-color: #ff4d4f; background-color: #fff2f0; }
        .loading { border-color: #1890ff; background-color: #e6f7ff; }
        button {
            background: #1890ff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #40a9ff; }
        button:disabled { background: #d9d9d9; cursor: not-allowed; }
        .result {
            margin-top: 15px;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .captcha-display {
            font-size: 18px;
            font-weight: bold;
            color: #1890ff;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ éªŒè¯ç ä¿®å¤æµ‹è¯•</h1>
        <p>æ­¤é¡µé¢ç”¨äºæµ‹è¯•æ•°å­¦é¢˜éªŒè¯ç åœ¨ Cloudflare éƒ¨ç½²ç¯å¢ƒä¸‹çš„æ˜¾ç¤ºé—®é¢˜ä¿®å¤ã€‚</p>
        
        <div id="test1" class="test-section">
            <h3>æµ‹è¯• 1: ç›´æ¥ API è°ƒç”¨</h3>
            <p>æµ‹è¯•ç›´æ¥è°ƒç”¨åç«¯ API è·å–éªŒè¯ç </p>
            <button onclick="testDirectAPI()">æµ‹è¯•ç›´æ¥ API</button>
            <div id="result1" class="result"></div>
        </div>

        <div id="test2" class="test-section">
            <h3>æµ‹è¯• 2: ç¯å¢ƒæ£€æµ‹</h3>
            <p>æ£€æµ‹å½“å‰ç¯å¢ƒå’Œ API åŸºç¡€ URL é…ç½®</p>
            <button onclick="testEnvironment()">æ£€æµ‹ç¯å¢ƒ</button>
            <div id="result2" class="result"></div>
        </div>

        <div id="test3" class="test-section">
            <h3>æµ‹è¯• 3: æ¨¡æ‹Ÿå‰ç«¯ç»„ä»¶è°ƒç”¨</h3>
            <p>æ¨¡æ‹Ÿå‰ç«¯ CaptchaInput ç»„ä»¶çš„è°ƒç”¨æ–¹å¼</p>
            <button onclick="testFrontendCall()">æµ‹è¯•å‰ç«¯è°ƒç”¨</button>
            <div id="result3" class="result"></div>
            <div id="captcha3" class="captcha-display"></div>
        </div>

        <div id="test4" class="test-section">
            <h3>æµ‹è¯• 4: ç½‘ç»œè¿é€šæ€§</h3>
            <p>æµ‹è¯•åˆ°å„ä¸ªç«¯ç‚¹çš„ç½‘ç»œè¿é€šæ€§</p>
            <button onclick="testConnectivity()">æµ‹è¯•è¿é€šæ€§</button>
            <div id="result4" class="result"></div>
        </div>
    </div>

    <script>
        // ç¯å¢ƒæ£€æµ‹å‡½æ•°ï¼ˆå¤åˆ¶è‡ª config.tsï¼‰
        function getApiBaseUrl() {
            if (window.location.hostname === 'zhenyan.asia' || window.location.hostname === 'www.zhenyan.asia') {
                return 'https://api.zhenyan.asia';
            }
            return 'http://localhost:8000';
        }

        function updateTestResult(testId, status, message) {
            const testDiv = document.getElementById(testId);
            const resultDiv = document.getElementById(`result${testId.slice(-1)}`);
            
            testDiv.className = `test-section ${status}`;
            resultDiv.textContent = message;
            resultDiv.className = `result ${status}`;
        }

        async function testDirectAPI() {
            updateTestResult('test1', 'loading', 'æ­£åœ¨æµ‹è¯•ç›´æ¥ API è°ƒç”¨...');
            
            try {
                const apiUrl = getApiBaseUrl();
                console.log('ä½¿ç”¨ API URL:', apiUrl);
                
                const response = await fetch(`${apiUrl}/api/auth/captcha`);
                
                if (response.ok) {
                    const data = await response.json();
                    updateTestResult('test1', 'success', 
                        `âœ… API è°ƒç”¨æˆåŠŸï¼\n` +
                        `çŠ¶æ€ç : ${response.status}\n` +
                        `éªŒè¯ç ID: ${data.captcha_id}\n` +
                        `æ•°å­¦é¢˜: ${data.question}\n` +
                        `ä¼šè¯ID: ${data.session_id}`
                    );
                } else {
                    updateTestResult('test1', 'error', 
                        `âŒ API è°ƒç”¨å¤±è´¥\nçŠ¶æ€ç : ${response.status}\nå“åº”: ${await response.text()}`
                    );
                }
            } catch (error) {
                updateTestResult('test1', 'error', `âŒ ç½‘ç»œé”™è¯¯: ${error.message}`);
            }
        }

        async function testEnvironment() {
            updateTestResult('test2', 'loading', 'æ­£åœ¨æ£€æµ‹ç¯å¢ƒ...');
            
            const apiUrl = getApiBaseUrl();
            const hostname = window.location.hostname;
            const protocol = window.location.protocol;
            const port = window.location.port;
            
            updateTestResult('test2', 'success', 
                `âœ… ç¯å¢ƒæ£€æµ‹å®Œæˆ\n` +
                `å½“å‰åŸŸå: ${hostname}\n` +
                `åè®®: ${protocol}\n` +
                `ç«¯å£: ${port || 'é»˜è®¤'}\n` +
                `API åŸºç¡€ URL: ${apiUrl}\n` +
                `æ˜¯å¦ç”Ÿäº§ç¯å¢ƒ: ${hostname.includes('zhenyan.asia') ? 'æ˜¯' : 'å¦'}`
            );
        }

        async function testFrontendCall() {
            updateTestResult('test3', 'loading', 'æ­£åœ¨æ¨¡æ‹Ÿå‰ç«¯ç»„ä»¶è°ƒç”¨...');
            
            try {
                const apiUrl = getApiBaseUrl();
                const response = await fetch(`${apiUrl}/api/auth/captcha`);
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // æ˜¾ç¤ºéªŒè¯ç 
                    const captchaDiv = document.getElementById('captcha3');
                    captchaDiv.innerHTML = `<strong>éªŒè¯ç ï¼š</strong>${data.question}`;
                    
                    updateTestResult('test3', 'success', 
                        `âœ… å‰ç«¯ç»„ä»¶è°ƒç”¨æˆåŠŸï¼\n` +
                        `è¿™æ¨¡æ‹Ÿäº† CaptchaInput ç»„ä»¶çš„è¡Œä¸º\n` +
                        `éªŒè¯ç å·²æ˜¾ç¤ºåœ¨ä¸Šæ–¹`
                    );
                } else {
                    updateTestResult('test3', 'error', 
                        `âŒ å‰ç«¯ç»„ä»¶è°ƒç”¨å¤±è´¥\nçŠ¶æ€ç : ${response.status}`
                    );
                }
            } catch (error) {
                updateTestResult('test3', 'error', `âŒ å‰ç«¯ç»„ä»¶è°ƒç”¨é”™è¯¯: ${error.message}`);
            }
        }

        async function testConnectivity() {
            updateTestResult('test4', 'loading', 'æ­£åœ¨æµ‹è¯•ç½‘ç»œè¿é€šæ€§...');
            
            const endpoints = [
                { name: 'åç«¯å¥åº·æ£€æŸ¥', url: `${getApiBaseUrl()}/health` },
                { name: 'è®¤è¯å¥åº·æ£€æŸ¥', url: `${getApiBaseUrl()}/api/auth/health` },
                { name: 'éªŒè¯ç ç«¯ç‚¹', url: `${getApiBaseUrl()}/api/auth/captcha` }
            ];
            
            let results = [];
            
            for (const endpoint of endpoints) {
                try {
                    const start = Date.now();
                    const response = await fetch(endpoint.url);
                    const duration = Date.now() - start;
                    
                    results.push(`${endpoint.name}: âœ… ${response.status} (${duration}ms)`);
                } catch (error) {
                    results.push(`${endpoint.name}: âŒ ${error.message}`);
                }
            }
            
            updateTestResult('test4', 'success', results.join('\n'));
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿è¡Œç¯å¢ƒæ£€æµ‹
        window.addEventListener('load', () => {
            testEnvironment();
        });
    </script>
</body>
</html>
