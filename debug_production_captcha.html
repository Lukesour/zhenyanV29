<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”Ÿäº§ç¯å¢ƒéªŒè¯ç è°ƒè¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success { border-color: #52c41a; background-color: #f6ffed; }
        .error { border-color: #ff4d4f; background-color: #fff2f0; }
        .loading { border-color: #1890ff; background-color: #e6f7ff; }
        button {
            background: #1890ff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #40a9ff; }
        button:disabled { background: #d9d9d9; cursor: not-allowed; }
        .result {
            margin-top: 15px;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .captcha-display {
            font-size: 24px;
            font-weight: bold;
            color: #1890ff;
            margin: 15px 0;
            padding: 15px;
            background: #f0f8ff;
            border-radius: 8px;
            text-align: center;
        }
        .info {
            background: #e6f7ff;
            border: 1px solid #91d5ff;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” ç”Ÿäº§ç¯å¢ƒéªŒè¯ç è°ƒè¯•å·¥å…·</h1>
        
        <div class="info">
            <strong>å½“å‰ç¯å¢ƒä¿¡æ¯ï¼š</strong><br>
            åŸŸå: <span id="hostname"></span><br>
            åè®®: <span id="protocol"></span><br>
            å®Œæ•´URL: <span id="fullUrl"></span><br>
            é¢„æœŸAPIåœ°å€: <span id="expectedApi"></span>
        </div>
        
        <div id="test1" class="test-section">
            <h3>æµ‹è¯• 1: ç¯å¢ƒæ£€æµ‹å’ŒAPIé…ç½®</h3>
            <p>æ£€æµ‹å½“å‰ç¯å¢ƒå¹¶éªŒè¯APIé…ç½®é€»è¾‘</p>
            <button onclick="testEnvironmentDetection()">æ£€æµ‹ç¯å¢ƒ</button>
            <div id="result1" class="result"></div>
        </div>

        <div id="test2" class="test-section">
            <h3>æµ‹è¯• 2: ç›´æ¥APIè°ƒç”¨ (CORSæµ‹è¯•)</h3>
            <p>ç›´æ¥è°ƒç”¨éªŒè¯ç APIï¼Œæ£€æŸ¥CORSå’Œç½‘ç»œè¿æ¥</p>
            <button onclick="testDirectApiCall()">æµ‹è¯•APIè°ƒç”¨</button>
            <div id="result2" class="result"></div>
            <div id="captcha2" class="captcha-display" style="display:none;"></div>
        </div>

        <div id="test3" class="test-section">
            <h3>æµ‹è¯• 3: æ¨¡æ‹Ÿå‰ç«¯ç»„ä»¶è¡Œä¸º</h3>
            <p>å®Œå…¨æ¨¡æ‹ŸCaptchaInputç»„ä»¶çš„è¡Œä¸º</p>
            <button onclick="simulateCaptchaComponent()">æ¨¡æ‹Ÿç»„ä»¶</button>
            <div id="result3" class="result"></div>
            <div id="captcha3" class="captcha-display" style="display:none;"></div>
        </div>

        <div id="test4" class="test-section">
            <h3>æµ‹è¯• 4: ç½‘ç»œè¯Šæ–­</h3>
            <p>è¯¦ç»†çš„ç½‘ç»œè¿æ¥å’Œå“åº”è¯Šæ–­</p>
            <button onclick="networkDiagnostics()">ç½‘ç»œè¯Šæ–­</button>
            <div id="result4" class="result"></div>
        </div>

        <div id="test5" class="test-section">
            <h3>æµ‹è¯• 5: æµè§ˆå™¨æ§åˆ¶å°æ—¥å¿—</h3>
            <p>æ•è·å’Œæ˜¾ç¤ºæµè§ˆå™¨æ§åˆ¶å°ä¸­çš„ç›¸å…³æ—¥å¿—</p>
            <button onclick="captureConsoleLogs()">å¼€å§‹æ—¥å¿—æ•è·</button>
            <button onclick="stopLogCapture()">åœæ­¢æ•è·</button>
            <div id="result5" class="result"></div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let originalConsoleLog = console.log;
        let originalConsoleError = console.error;
        let originalConsoleWarn = console.warn;
        let logCapture = false;
        let capturedLogs = [];

        // åˆå§‹åŒ–é¡µé¢ä¿¡æ¯
        document.getElementById('hostname').textContent = window.location.hostname;
        document.getElementById('protocol').textContent = window.location.protocol;
        document.getElementById('fullUrl').textContent = window.location.href;
        
        // å¤åˆ¶å‰ç«¯çš„ç¯å¢ƒæ£€æµ‹é€»è¾‘
        function getApiBaseUrl() {
            if (window.location.hostname === 'zhenyan.asia' || window.location.hostname === 'www.zhenyan.asia') {
                return 'https://api.zhenyan.asia';
            }
            return process.env.REACT_APP_API_URL || 'http://localhost:8000';
        }
        
        document.getElementById('expectedApi').textContent = getApiBaseUrl();

        function updateTestResult(testId, status, message) {
            const testDiv = document.getElementById(testId);
            const resultDiv = document.getElementById(`result${testId.slice(-1)}`);
            
            testDiv.className = `test-section ${status}`;
            resultDiv.textContent = message;
            resultDiv.className = `result ${status}`;
        }

        function testEnvironmentDetection() {
            updateTestResult('test1', 'loading', 'æ­£åœ¨æ£€æµ‹ç¯å¢ƒ...');
            
            const hostname = window.location.hostname;
            const isProduction = hostname === 'zhenyan.asia' || hostname === 'www.zhenyan.asia';
            const apiUrl = getApiBaseUrl();
            
            const result = `âœ… ç¯å¢ƒæ£€æµ‹å®Œæˆ
å½“å‰åŸŸå: ${hostname}
æ˜¯å¦ç”Ÿäº§ç¯å¢ƒ: ${isProduction ? 'æ˜¯' : 'å¦'}
APIåŸºç¡€URL: ${apiUrl}
ç”¨æˆ·ä»£ç†: ${navigator.userAgent}
æ—¶é—´æˆ³: ${new Date().toISOString()}`;
            
            updateTestResult('test1', 'success', result);
        }

        async function testDirectApiCall() {
            updateTestResult('test2', 'loading', 'æ­£åœ¨æµ‹è¯•APIè°ƒç”¨...');
            
            const apiUrl = getApiBaseUrl();
            const endpoint = `${apiUrl}/api/auth/captcha`;
            
            try {
                console.log('å¼€å§‹è°ƒç”¨API:', endpoint);
                
                const response = await fetch(endpoint, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    mode: 'cors', // æ˜ç¡®æŒ‡å®šCORSæ¨¡å¼
                });
                
                console.log('APIå“åº”çŠ¶æ€:', response.status);
                console.log('APIå“åº”å¤´:', [...response.headers.entries()]);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('APIå“åº”æ•°æ®:', data);
                    
                    // æ˜¾ç¤ºéªŒè¯ç 
                    const captchaDiv = document.getElementById('captcha2');
                    captchaDiv.innerHTML = `éªŒè¯ç : ${data.question}`;
                    captchaDiv.style.display = 'block';
                    
                    const result = `âœ… APIè°ƒç”¨æˆåŠŸ!
ç«¯ç‚¹: ${endpoint}
çŠ¶æ€ç : ${response.status}
éªŒè¯ç ID: ${data.captcha_id}
æ•°å­¦é¢˜: ${data.question}
ä¼šè¯ID: ${data.session_id}
å“åº”æ—¶é—´: ${new Date().toISOString()}`;
                    
                    updateTestResult('test2', 'success', result);
                } else {
                    const errorText = await response.text();
                    const result = `âŒ APIè°ƒç”¨å¤±è´¥
ç«¯ç‚¹: ${endpoint}
çŠ¶æ€ç : ${response.status}
çŠ¶æ€æ–‡æœ¬: ${response.statusText}
å“åº”å†…å®¹: ${errorText}`;
                    
                    updateTestResult('test2', 'error', result);
                }
            } catch (error) {
                console.error('APIè°ƒç”¨å¼‚å¸¸:', error);
                
                const result = `âŒ APIè°ƒç”¨å¼‚å¸¸
ç«¯ç‚¹: ${endpoint}
é”™è¯¯ç±»å‹: ${error.name}
é”™è¯¯æ¶ˆæ¯: ${error.message}
é”™è¯¯å †æ ˆ: ${error.stack}`;
                
                updateTestResult('test2', 'error', result);
            }
        }

        async function simulateCaptchaComponent() {
            updateTestResult('test3', 'loading', 'æ­£åœ¨æ¨¡æ‹ŸCaptchaInputç»„ä»¶...');
            
            // å®Œå…¨æ¨¡æ‹ŸCaptchaInputç»„ä»¶çš„fetchCaptchaæ–¹æ³•
            try {
                const apiUrl = getApiBaseUrl();
                const response = await fetch(`${apiUrl}/api/auth/captcha`);
                
                if (response.ok) {
                    const data = await response.json();
                    const newCaptchaData = {
                        captcha_id: data.captcha_id,
                        question: data.question,
                        session_id: data.session_id
                    };
                    
                    // æ˜¾ç¤ºéªŒè¯ç ï¼ˆæ¨¡æ‹Ÿç»„ä»¶UIï¼‰
                    const captchaDiv = document.getElementById('captcha3');
                    captchaDiv.innerHTML = `
                        <div style="margin-bottom: 8px;">
                            <span style="font-weight: bold;">éªŒè¯ç ï¼š</span>
                            <span style="margin-left: 8px; padding: 4px 8px; background-color: #f0f0f0; border-radius: 4px; font-family: monospace; font-size: 16px;">
                                ${newCaptchaData.question}
                            </span>
                        </div>
                    `;
                    captchaDiv.style.display = 'block';
                    
                    const result = `âœ… CaptchaInputç»„ä»¶æ¨¡æ‹ŸæˆåŠŸ!
è¿™å®Œå…¨æ¨¡æ‹Ÿäº†å‰ç«¯ç»„ä»¶çš„è¡Œä¸º
éªŒè¯ç å·²åœ¨ä¸Šæ–¹æ˜¾ç¤º
ç»„ä»¶æ•°æ®: ${JSON.stringify(newCaptchaData, null, 2)}`;
                    
                    updateTestResult('test3', 'success', result);
                } else {
                    const result = `âŒ ç»„ä»¶æ¨¡æ‹Ÿå¤±è´¥
çŠ¶æ€ç : ${response.status}
è¿™æ„å‘³ç€å‰ç«¯ç»„ä»¶ä¹Ÿä¼šå¤±è´¥`;
                    
                    updateTestResult('test3', 'error', result);
                }
            } catch (error) {
                const result = `âŒ ç»„ä»¶æ¨¡æ‹Ÿå¼‚å¸¸: ${error.message}
è¿™æ„å‘³ç€å‰ç«¯ç»„ä»¶ä¹Ÿä¼šé‡åˆ°åŒæ ·çš„é”™è¯¯`;
                
                updateTestResult('test3', 'error', result);
            }
        }

        async function networkDiagnostics() {
            updateTestResult('test4', 'loading', 'æ­£åœ¨è¿›è¡Œç½‘ç»œè¯Šæ–­...');
            
            const apiUrl = getApiBaseUrl();
            const endpoints = [
                `${apiUrl}/health`,
                `${apiUrl}/api/auth/health`,
                `${apiUrl}/api/auth/captcha`
            ];
            
            let diagnostics = [`ç½‘ç»œè¯Šæ–­æŠ¥å‘Š - ${new Date().toISOString()}`];
            
            for (const endpoint of endpoints) {
                try {
                    const start = performance.now();
                    const response = await fetch(endpoint, { method: 'HEAD' });
                    const duration = Math.round(performance.now() - start);
                    
                    diagnostics.push(`âœ… ${endpoint}: ${response.status} (${duration}ms)`);
                } catch (error) {
                    diagnostics.push(`âŒ ${endpoint}: ${error.message}`);
                }
            }
            
            // DNSè§£ææµ‹è¯•
            try {
                const dnsStart = performance.now();
                await fetch(`${apiUrl}/health`, { method: 'HEAD' });
                const dnsTime = Math.round(performance.now() - dnsStart);
                diagnostics.push(`DNSè§£ææ—¶é—´: ${dnsTime}ms`);
            } catch (error) {
                diagnostics.push(`DNSè§£æå¤±è´¥: ${error.message}`);
            }
            
            updateTestResult('test4', 'success', diagnostics.join('\n'));
        }

        function captureConsoleLogs() {
            logCapture = true;
            capturedLogs = [];
            
            console.log = function(...args) {
                if (logCapture) {
                    capturedLogs.push(`[LOG] ${new Date().toISOString()}: ${args.join(' ')}`);
                }
                originalConsoleLog.apply(console, args);
            };
            
            console.error = function(...args) {
                if (logCapture) {
                    capturedLogs.push(`[ERROR] ${new Date().toISOString()}: ${args.join(' ')}`);
                }
                originalConsoleError.apply(console, args);
            };
            
            console.warn = function(...args) {
                if (logCapture) {
                    capturedLogs.push(`[WARN] ${new Date().toISOString()}: ${args.join(' ')}`);
                }
                originalConsoleWarn.apply(console, args);
            };
            
            updateTestResult('test5', 'loading', 'æ—¥å¿—æ•è·å·²å¼€å§‹...\nç°åœ¨å¯ä»¥å°è¯•å…¶ä»–æµ‹è¯•ï¼Œæ—¥å¿—å°†è¢«è®°å½•');
        }

        function stopLogCapture() {
            logCapture = false;
            console.log = originalConsoleLog;
            console.error = originalConsoleError;
            console.warn = originalConsoleWarn;
            
            const result = capturedLogs.length > 0 
                ? `æ•è·çš„æ—¥å¿— (${capturedLogs.length} æ¡):\n\n${capturedLogs.join('\n')}`
                : 'æœªæ•è·åˆ°ä»»ä½•æ—¥å¿—';
                
            updateTestResult('test5', 'success', result);
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿è¡Œç¯å¢ƒæ£€æµ‹
        window.addEventListener('load', () => {
            testEnvironmentDetection();
        });
    </script>
</body>
</html>
