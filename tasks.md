# **数据库架构重构实施计划**

## **阶段1：标记废弃代码**

### **1.1 创建废弃标记工具**
**目标**：实现废弃代码标记机制，为后续移除做准备
- 创建 `utils/deprecation.py` 文件，实现废弃警告装饰器
- 实现废弃代码检测和报告功能
- 添加废弃时间表管理

**需求引用**：REQ-047, REQ-001, REQ-002

### **1.2 标记PostgreSQL配置代码**
**目标**：在配置管理代码中添加废弃警告
- 修改 `config/settings.py`，为PostgreSQL配置项添加废弃警告
- 更新 `config/__init__.py`，标记数据库类型判断逻辑
- 添加配置验证警告

**需求引用**：REQ-006, REQ-008, REQ-009

### **1.3 标记PostgreSQL数据访问代码**
**目标**：在数据访问层添加废弃警告
- 修改 `models/database.py`，标记PostgreSQL连接代码
- 更新 `services/supabase_service.py`，标记双重数据库选择逻辑
- 添加数据访问层废弃警告

**需求引用**：REQ-011, REQ-013, REQ-014

### **1.4 标记PostgreSQL测试代码**
**目标**：在测试代码中添加废弃警告
- 修改 `tests/` 目录下的PostgreSQL相关测试文件
- 更新测试配置，标记PostgreSQL测试环境
- 添加测试废弃警告

**需求引用**：REQ-021, REQ-022, REQ-023

### **1.5 创建废弃代码报告**
**目标**：实现废弃代码检测和报告功能
- 创建 `scripts/deprecation_report.py` 脚本
- 实现废弃代码扫描功能
- 生成废弃代码清单报告

**需求引用**：REQ-047, REQ-048

## **阶段2：移除依赖和配置**

### **2.1 更新Python依赖文件**
**目标**：移除PostgreSQL相关的Python包依赖
- 修改 `requirements.txt`，移除psycopg2-binary等PostgreSQL依赖
- 更新 `requirements.in`（如果存在），移除PostgreSQL包
- 验证依赖移除后的包冲突

**需求引用**：REQ-032, REQ-033, REQ-034

### **2.2 清理配置文件**
**目标**：移除PostgreSQL相关的配置项
- 修改 `config/settings.py`，删除PostgreSQL配置类
- 更新环境变量定义，移除PostgreSQL相关变量
- 简化配置验证逻辑

**需求引用**：REQ-006, REQ-007, REQ-010

### **2.3 更新Docker配置**
**目标**：移除PostgreSQL相关的Docker配置
- 修改 `docker-compose.yml`，移除PostgreSQL服务
- 更新 `Dockerfile`，移除PostgreSQL相关层
- 简化Docker启动脚本

**需求引用**：REQ-018, REQ-036

### **2.4 创建依赖验证测试**
**目标**：实现依赖移除后的验证测试
- 创建 `tests/test_dependencies.py`，验证无PostgreSQL依赖
- 实现依赖包冲突检测
- 添加依赖完整性测试

**需求引用**：REQ-035, REQ-034

### **2.5 更新启动脚本**
**目标**：简化启动脚本，移除PostgreSQL相关检查
- 修改启动脚本，移除PostgreSQL连接测试
- 更新健康检查，只检查Supabase连接
- 简化环境变量验证

**需求引用**：REQ-016, REQ-017, REQ-019

## **阶段3：清理数据访问层**

### **3.1 重构数据库管理器**
**目标**：移除PostgreSQL数据访问代码，简化数据库管理器
- 修改 `models/database.py`，移除PostgreSQL客户端
- 简化数据库管理器初始化逻辑
- 移除数据库类型判断代码

**需求引用**：REQ-011, REQ-013, REQ-014

### **3.2 更新数据模型**
**目标**：简化数据模型，移除PostgreSQL特定字段
- 修改 `models/schemas.py`，移除PostgreSQL ID字段
- 统一使用Supabase UUID格式
- 添加标准时间戳字段

**需求引用**：REQ-012, REQ-015

### **3.3 重构服务层**
**目标**：更新服务层，移除PostgreSQL相关逻辑
- 修改 `services/analysis_service.py`，移除数据库选择逻辑
- 更新 `services/similarity_matcher.py`，简化数据查询
- 移除PostgreSQL事务处理代码

**需求引用**：REQ-004, REQ-014

### **3.4 创建数据验证器**
**目标**：实现Supabase连接和数据完整性验证
- 创建 `utils/data_validator.py`，实现连接验证
- 添加数据完整性检查功能
- 实现错误处理机制

**需求引用**：REQ-005, REQ-027

### **3.5 更新错误处理**
**目标**：简化错误处理，移除PostgreSQL特定错误
- 修改 `api/errors.py`，移除PostgreSQL错误类
- 统一错误处理接口
- 简化错误日志格式

**需求引用**：REQ-027, REQ-028, REQ-029

## **阶段4：移除测试环境**

### **4.1 删除PostgreSQL测试用例**
**目标**：移除所有PostgreSQL相关的测试用例
- 删除 `tests/` 目录下的PostgreSQL测试文件
- 移除测试配置中的PostgreSQL设置
- 清理测试数据中的PostgreSQL相关数据

**需求引用**：REQ-021, REQ-022, REQ-023

### **4.2 更新集成测试**
**目标**：重构集成测试，只使用Supabase
- 修改 `tests/integration/` 目录下的测试文件
- 更新测试环境配置，移除PostgreSQL容器
- 简化测试数据准备逻辑

**需求引用**：REQ-022, REQ-023

### **4.3 重构测试工具**
**目标**：更新测试工具和辅助函数
- 修改 `tests/utils.py`，移除PostgreSQL测试工具
- 更新测试夹具，只支持Supabase
- 简化测试环境设置

**需求引用**：REQ-023, REQ-024

### **4.4 创建Supabase测试环境**
**目标**：实现专门的Supabase测试环境
- 创建 `tests/conftest.py`，配置Supabase测试环境
- 实现测试数据清理机制
- 添加测试隔离功能

**需求引用**：REQ-022, REQ-025

### **4.5 更新测试文档**
**目标**：更新测试相关文档
- 修改测试README文件，移除PostgreSQL说明
- 更新测试运行指南
- 简化测试配置说明

**需求引用**：REQ-024, REQ-025

## **阶段5：清理监控和日志**

### **5.1 移除PostgreSQL监控指标**
**目标**：清理监控代码，移除PostgreSQL相关指标
- 修改监控配置文件，移除PostgreSQL指标
- 更新监控面板配置
- 简化监控数据收集

**需求引用**：REQ-042, REQ-045

### **5.2 清理历史日志**
**目标**：清理日志代码，移除PostgreSQL相关信息
- 修改日志配置，移除PostgreSQL相关字段
- 更新日志格式，简化日志输出
- 清理历史日志文件

**需求引用**：REQ-043, REQ-044

### **5.3 更新告警规则**
**目标**：更新告警配置，移除PostgreSQL相关告警
- 修改告警配置文件，移除PostgreSQL告警
- 更新告警规则，只监控Supabase
- 简化告警通知机制

**需求引用**：REQ-046, REQ-031

### **5.4 重构健康检查**
**目标**：简化健康检查，只检查Supabase
- 修改健康检查端点，移除PostgreSQL检查
- 更新健康检查逻辑，简化检查流程
- 统一健康检查响应格式

**需求引用**：REQ-030, REQ-031

### **5.5 创建监控验证测试**
**目标**：实现监控和日志功能的验证测试
- 创建 `tests/test_monitoring.py`，验证监控功能
- 实现日志格式验证测试
- 添加告警规则验证

**需求引用**：REQ-045, REQ-046

## **阶段6：集成和验证**

### **6.1 创建端到端测试**
**目标**：实现完整的端到端测试，验证重构后的系统
- 创建 `tests/e2e/test_database_flow.py`，测试完整数据流
- 实现用户场景测试
- 验证系统功能完整性

**需求引用**：REQ-052, REQ-053

### **6.2 实现回滚机制**
**目标**：创建回滚脚本，支持快速回滚到前一阶段
- 创建 `scripts/rollback.py`，实现回滚功能
- 实现配置回滚机制
- 添加数据回滚验证

**需求引用**：REQ-053

### **6.3 创建性能基准测试**
**目标**：实现性能测试，验证重构后的性能
- 创建 `tests/performance/test_database_performance.py`
- 实现数据库连接性能测试
- 验证查询性能基准

**需求引用**：REQ-052

### **6.4 更新API文档**
**目标**：更新API文档，移除PostgreSQL相关说明
- 修改API文档，移除PostgreSQL配置说明
- 更新示例代码，只使用Supabase
- 简化API使用指南

**需求引用**：REQ-024, REQ-025

### **6.5 创建迁移验证脚本**
**目标**：实现迁移验证，确保重构成功
- 创建 `scripts/validate_migration.py`，验证迁移结果
- 实现功能完整性检查
- 添加性能对比验证

**需求引用**：REQ-052, REQ-053

## **测试驱动开发指导**

### **每个任务的测试优先原则**
- 每个编码任务都应该从编写测试开始
- 测试应该验证功能的正确性和边界情况
- 测试应该覆盖错误处理和异常情况

### **渐进式测试策略**
- 单元测试：验证单个组件的功能
- 集成测试：验证组件间的交互
- 端到端测试：验证完整的用户场景

### **测试数据管理**
- 使用测试夹具管理测试数据
- 实现测试数据清理机制
- 确保测试的隔离性和可重复性

## **质量保证检查点**

### **每个阶段完成后的检查**
- 所有测试通过
- 代码覆盖率不低于90%
- 无废弃警告
- 性能基准达标

### **集成检查**
- 端到端功能测试通过
- 性能测试通过
- 安全扫描通过
- 代码审查通过

